<script type="text/javascript">
	RED.nodes.registerType('wio-event', {
		paletteLabel: 'event',
		category: 'wio',
		color: '#C0EDC0',
		defaults: {
			name: { value: '' },
			connection: { value: '', type: 'wio-config' },
			node: { value: '' },
			events: { value: [] }
		},
		inputs: 1,
		outputs: 1,
		icon: 'file.png',
		label: function () {
			return this.name || 'event';
		},
		oneditprepare: function () {
			var config = this;
			var events = {
				'101020020': {
					name: 'Grove PIR Motion',
					events: {
						'ir_moved': 'PIR Moved'
					}
				}
			};
			$.getScript('wio-common').done(function (res) {
				WioCommon(config);

				var addEvent = $('#node-input-add-event');
				var eventsContainer = $('#node-input-event-container');

				addEvent.on('click', function () {
					generateEvent((eventsContainer.children().length + 1), {});
				});

				for (var i = 0; i < config.events.length; i++)
					generateEvent((i + 1), config.events[i]);

				function generateEvent(index, event) {
					var container = $('<li/>')
						.attr('style', 'background: #fff; margin:0; padding: 8px 0px; border-bottom: 1px solid #ccc;');
					var row = $('<div/>').appendTo(container);

					var eventSelect = $('<select/>')
						.attr('class', 'node-input-event-type')
						.attr('style', 'width: 250px; margin-left: 5px;')
						.appendTo(row);
					for (var key in events)
						if (events.hasOwnProperty(key))
							for (var type in events[key].events)
								if (events[key].events.hasOwnProperty(type))
									$('<option/>').attr('value', type)
										.text(events[key].name + ' - ' + events[key].events[type])
										.appendTo(eventSelect);
					if (event.type)
						eventSelect.val(event.type);

					var outputSelect = $('<select/>')
						.attr('class', 'node-input-event-output')
						.attr('style', 'width: 80px; margin-left: 5px;')
						.appendTo(row);
					$('<option/>').attr('value', 'value').text('Value').appendTo(outputSelect);
					$('<option/>').attr('value', 'object').text('Object').appendTo(outputSelect);
					if (event.output)
						outputSelect.val(event.output);

					var finalSpan = $('<span/>')
						.attr('style', 'float: right; margin-right: 10px;')
						.append(' &#8594; ')
						.appendTo(row);

					$('<span/>').attr('class', 'node-input-event-index')
						.text(index).appendTo(finalSpan);

					var deleteButton = $('<a/>')
						.attr('href', '#')
						.attr('class', 'editor-button editor-button-small')
						.attr('style', 'margin-top: 7px; margin-left: 5px;')
						.appendTo(finalSpan);
					$('<i/>').attr('class', 'fa fa-remove').appendTo(deleteButton);

					deleteButton.on('click', function () {
						container
							.css('background', '#FEE')
							.fadeOut(300, function () {
								$(this).remove();
								eventsContainer.children().each(function (index) {
									$(this).find('.node-input-event-index').text(index + 1);
								});
							});
					});

					eventsContainer.append(container);
				}
			});
		},
		oneditsave: function () {
			var config = this;
			config.events = [];
			var eventsContainer = $('#node-input-event-container');

			eventsContainer.children().each(function (index) {
				var event = $(this);
				config.events.push({
					type: event.find('.node-input-event-type').val(),
					output: event.find('.node-input-event-output').val()
				});
			});

			config.outputs = config.events.length;
		}
	});
</script>

<script type="text/x-red" data-template-name="wio-event">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-input-connection"><i class="icon-tag"></i> Connection</label>
		<select type="text" id="node-input-connection"></select>
	</div>
	<div class="form-row">
		<label for="node-input-node"><i class="icon-tag"></i> Node</label>
		<select type="text" id="node-input-node"></select>
	</div>
	<div class="form-row node-input-event-container-row" style="margin-bottom: 0px;">
		<div id="node-input-event-container-div" style="box-sizing: border-box; border-radius: 5px; height: 310px; padding: 5px; border: 1px solid #ccc; overflow-y: scroll;">
			<ol id="node-input-event-container" style="list-style-type: none; margin: 0;"></ol>
		</div>
	</div>
	<div class="form-row">
		<a href="#" class="editor-button editor-button-small" id="node-input-add-event" style="margin-top: 4px;"><i class="fa fa-plus"></i> Add Event</a>
	</div>
</script>

<script type="text/x-red" data-help-name="wio-event">
	<p>Wio Events</p>
</script>